{% extends 'base/base.html' %}

{% block content %}
<h2>Listado de Libros</h2>

{% if messages %}
    <div class="alert-container">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if user.is_authenticated %}
    {% if user.is_superuser %}
        <p><a href="{% url 'gestion_libros:libro_create' %}" class="btn btn-primary">Añadir nuevo Libro</a></p>
    {% endif %}

    <!-- Formulario de búsqueda y filtro por categoría -->
    <form method="GET" action="{% url 'gestion_libros:libro_list' %}">
        <input type="text" id="search" name="q" placeholder="Buscar por título, autor, apellido, editorial" value="{{ request.GET.q }}">

        <!-- Select para filtrar por categoría -->
        <select name="categoria">
            <option value="">Todas las Categorías</option>
            {% for categoria in categorias %}
                <option value="{{ categoria.id }}" {% if request.GET.categoria == categoria.id|stringformat:"s" %}selected{% endif %}>{{ categoria.nombre }}</option>
            {% endfor %}
        </select>

        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>

    {% if request.GET.q or request.GET.categoria %}
        <p><a href="{% url 'gestion_libros:libro_list' %}" class="btn btn-secondary">Volver a la lista completa</a></p>
    {% endif %}

    <!-- Tabla con los libros -->
    <table>
        <thead>
            <tr>
                <!-- Ordenar por Título -->
                <th>
                    <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.categoria %}categoria={{ request.GET.categoria }}&{% endif %}sort=titulo&order={% if sort_by == 'titulo' and order == 'asc' %}desc{% else %}asc{% endif %}">
                        Título
                        {% if sort_by == 'titulo' %}
                            {% if order == 'asc' %} ↑ {% else %} ↓ {% endif %}
                        {% endif %}
                    </a>
                </th>

                <!-- Ordenar por Fecha de Publicación -->
                <th>
                    <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.categoria %}categoria={{ request.GET.categoria }}&{% endif %}sort=fecha_publicacion&order={% if sort_by == 'fecha_publicacion' and order == 'asc' %}desc{% else %}asc{% endif %}">
                        Fecha de Publicación
                        {% if sort_by == 'fecha_publicacion' %}
                            {% if order == 'asc' %} ↑ {% else %} ↓ {% endif %}
                        {% endif %}
                    </a>
                </th>

                <!-- Ordenar por Editorial -->
                <th>
                    <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.categoria %}categoria={{ request.GET.categoria }}&{% endif %}sort=editorial&order={% if sort_by == 'editorial' and order == 'asc' %}desc{% else %}asc{% endif %}">
                        Editorial
                        {% if sort_by == 'editorial' %}
                            {% if order == 'asc' %} ↑ {% else %} ↓ {% endif %}
                        {% endif %}
                    </a>
                </th>

                <!-- Ordenar por Categoría -->
                <th>
                    <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.categoria %}categoria={{ request.GET.categoria }}&{% endif %}sort=categoria&order={% if sort_by == 'categoria' and order == 'asc' %}desc{% else %}asc{% endif %}">
                        Categoría
                        {% if sort_by == 'categoria' %}
                            {% if order == 'asc' %} ↑ {% else %} ↓ {% endif %}
                        {% endif %}
                    </a>
                </th>

                {% if user.is_superuser %}
                <th>Acciones</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for libro in libros %}
            <tr>
                <td>{{ libro.titulo }}</td>
                <td>{{ libro.fecha_publicacion }}</td>
                <td>{{ libro.editorial.nombre }}</td>
                <td>{{ libro.categoria.nombre }}</td>
                {% if user.is_superuser %}
                <td>
                    <!-- Botón de editar libro -->
                    <a href="{% url 'gestion_libros:libro_edit' libro.id %}" class="btn btn-warning">Editar</a>

                    <!-- Botón de eliminar que redirige a la vista de confirmación -->
                    <a href="{% url 'gestion_libros:libro_confirm_delete' libro.id %}" class="btn btn-danger">Eliminar</a>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if request.GET.q or request.GET.categoria %}
    <p><a href="{% url 'gestion_libros:libro_list' %}" class="btn btn-secondary">Volver a la lista completa</a></p>
    {% endif %}

    {% if user.is_superuser %}
    <p><a href="{% url 'gestion_libros:libro_create' %}" class="btn btn-primary">Añadir nuevo Libro</a></p>
    {% endif %}
{% else %}
    <p>Debes iniciar sesión para ver el listado de libros.</p>
    <p><a href="{% url 'login' %}">Iniciar sesión</a></p>
{% endif %}

<p><a href="{% url 'users:profile' %}">Volver al Perfil</a></p>

{% endblock %}
